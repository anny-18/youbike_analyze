---
title: "台北市 YouBike 2.0 ## 租借量不平衡站點分析"
author: "Wu Cheng Yun"
date: "2025-07-15"
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse) 
library(stringdist)
library(knitr)
library(kableExtra)
library(knitr)

# library(lubridate)
library(geosphere) 
library(ggrepel)
# library(scales)
# library(ggnewscale)
# library(readr)
```

本專案旨在分析位於台北市的 YouBike 2.0 各站點的供需情況，探查其使用模式，
識別供需不平衡的站點。
並根據不同時間段及調度需求，提出站點間車輛調度的初步策略建議。

主要資料來源為臺北市政府交通局提供的 2024 年 7 月至 12 月「臺北市公共自行車 2.0 租借紀錄」，
以及「YouBike2.0臺北市公共自行車即時資訊」

--------------------------------------
### 1. 資料說明
主要資料來源為臺北市政府交通局提供的 2024 年 7 月至 12 月「[臺北市公共自行車 2.0 租借紀錄](https://data.gov.tw/dataset/150635)」，
及「[YouBike2.0臺北市公共自行車即時資訊](https://data.gov.tw/dataset/137993)」。
另外，因資料清理所需，也同樣使用「[新北市公共自行車租賃系統(YouBike2.0)](https://data.ntpc.gov.tw/datasets/010e5b15-3823-4b20-b401-b1cf000550c5)」，「[桃園公共自行車即時服務資料](https://opendata.tycg.gov.tw/datalist/5ca2bfc7-9ace-4719-88ae-4034b9a5a55c)」。  
  
#### 資料期間
2024年7月至12月之台北市Youbike租借紀錄。以及2025年7月之台北市、新北市及桃園市Youbike站點資料。  

#### 資料型態
```{r data discribe, echo=FALSE}
# 建立租借紀錄資料框
df <- tibble(
  欄位名稱 = c("start_time", "start_station", "end_time", "end_station", "duration", "ride_date"),
  資料型態 = c("字串", "字串", "字串", "字串", "字串", "日期"),
  說明 = c("借車時間", "借車站點", "還車時間", "還車站點", "借用時長", "借用日期")
)

# 使用kable輸出表格，並用kableExtra美化
kable(df, format = "html", caption = "台北市Youbike租借紀錄") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# 建立台北市資料框
df <- tibble(
  欄位名稱 = c("station_id", "station_name", "district", "address", "latitude", "longitude", "capacity"),
  資料型態 = c("字串", "字串", "字串", "字串", "數值", "數值", "整數"),
  說明 = c("站點編號", "站名", "行政區", "地址", "緯度", "經度", "容量")
)

# 使用kable輸出表格，並用kableExtra美化
kable(df, format = "html", caption = "台北市站點") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# 建立新北市資料框
df <- tibble(
  欄位名稱 = c("station_id", "station_name", "district", "address", "latitude", "longitude"),
  資料型態 = c("字串", "字串", "字串", "字串", "數值", "數值"),
  說明 = c("站點編號", "站名", "行政區", "地址", "緯度", "經度")
)

# 使用kable輸出表格，並用kableExtra美化
kable(df, format = "html", caption = "新北市站點") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


# 建立桃園市資料框
df <- tibble(
  欄位名稱 = c("station_name"),
  資料型態 = c("字串"),
  說明 = c("站名")
)
# 使用kable輸出表格，並用kableExtra美化
kable(df, format = "html", caption = "桃園市站點") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


```


### 2. 資料取得與整合

#### 

此專題使用3個資料集，分別是:  
- all_data [使用者租借紀錄]  
- station_data：station_data_taipei [台北市站點資料] 及 station_data_newtaipei [新北市站點資料]  
- station_data_taoyuan [桃園市站點資料]  


根據官方的格式及取得方式，分別採取以下方式取得：
<details>
<summary><strong>
<span style="font-size:15px;">all_data <點此展開>
</strong></summary>
<br>
取得方式：下載自官網之CSV檔, 並整合而成。<br>
<br>
取得欄位：「借車時間」, 「借車站點」, 「還車時間」, 「還車站點」, 「借用時長」, 「借用日期」<br>
<br>
由於6月至10月之資料裡未紀錄車型資料，因此匯入資料時分類進行。<br>
若無車型資料，直接加入all_data。<br>
若有車型資料，則先剔除車型資料後再加入all_data中。<br>
<br>
其中，由於部分租借紀錄的duration(借用借用時長)超過24小時，因此先以字串方式匯入。爾後，再另外將資料型態轉為時間。

```{r get borrow records, eval = FALSE, echo=TRUE}

#垂直合併資料
files <- list.files(path = "dataset", pattern = "\\.csv$", full.names = TRUE)

#部分資料集未包含車型,因此將分開處理
col_names_7 <- c("start_time", "start_station", "end_time", "end_station", "duration", "bike_type", "ride_date")
col_names_6 <- c("start_time", "start_station", "end_time", "end_station", "duration", "ride_date")

#建立空tibble以儲存資料
all_data <- tibble()

#將資料存入all_data
for(f in files[1:6]){
  
  #取得欄位數量,判斷此資料集是否包含車型資料
  first_line <- readLines(f, n=1)
  column_count <- str_count(first_line, ",")+1
  
  #若無車型資料(column_count=6),直接存入data
  if(column_count==6){  
    data <- read_csv(f, col_names = col_names_6, col_type = cols(duration=col_character())) 
    #duration以字串方式匯入,其他自行判斷資料型態
  }
  #若有車型資料(column_count=7),則刪除車型資料後, 再存入data
  else if(column_count==7){ 
    data <- read_csv(f, col_names = col_names_7, col_type = cols(duration=col_character())) 
    #duration以字串方式匯入,其他自行判斷資料型態
    data <- select(data, -bike_type)
  }
  else{
    cat("error:", f, "\n")
  }
  #將data寫入all_data
  all_data <-bind_rows(all_data,data)
  
}

```
</details>
<details>
<summary><strong>
<span style="font-size:15px;">station_data <點此展開>
</strong></summary>
取得方式：<br>
station_data_taipei：以線上JSON檔取得<br>
station_data_newtaipei：透過API分頁取得JSON格式資料<br>
<br>
取得欄位：「站點編號」, 「站名」, 「行政區」, 「地址」, 「緯度」, 「經度」<br>
<br>
透過相對應方式取得資料後，將其合併成station_data，供之後用來比對站點名稱是否正確。
<br>
並針對所需調整，<br>
為區別台北市與新北市的站點區域，將行政區前分別加上「台北市」或「新北市」。<br>
另外，由於站點前皆有前綴文字「YouBike2.0_」，考慮分析效率，將其刪除。<br>

```{r get taipei station, eval=FALSE, echo=TRUE}
#台北市站點
station_data_taipei <- fromJSON("https://tcgbusfs.blob.core.windows.net/dotapp/youbike/v2/youbike_immediate.json")
station_data_taipei <- station_data_taipei %>%
  select(sno, sna, sarea, ar, latitude, longitude, Quantity) %>%
  rename(station_id=sno, station_name=sna, district=sarea, address=ar, capacity=Quantity) %>% 
  mutate(district=paste0("台北市",district))

#新北市站點
station_data_newtaipei <-{
  page <-0
  size <-100
  data <- list()
  repeat{
    url<-paste0("https://data.ntpc.gov.tw/api/datasets/010e5b15-3823-4b20-b401-b1cf000550c5/json?page=", page, "&size=", size)
    data_page <-fromJSON(url)
    if(length(data_page) == 0) break
    data[[page+1]] <- data_page
    page <- page+1
  }
  bind_rows(data)
  
}
#留下所需欄位，並根據需求調整
station_data_newtaipei <- station_data_newtaipei %>%
  select(sno, sna, sarea, ar, lat, lng) %>%
  rename(station_id=sno, station_name=sna, district=sarea, address=ar, latitude=lat, longitude=lng) %>% 
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude),
    district=paste0("新北市",district)
  )

#合併台北市及新北市資料
station_data <- bind_rows(station_data_taipei, station_data_newtaipei)

#去除station_name前的多餘字串
station_data <- station_data %>%
  mutate(station_name = str_remove(station_name, "^YouBike2.0_"))
```
</details>
<details>
<summary><strong>
<span style="font-size:15px;">station_data_taoyuan <點此展開>
</strong></summary>
取得方式：自官網下載JSON檔後載入<br>
<br>
取得欄位：「站名」<br>
<br>
部分紀錄還車站點位於桃園，由於僅佔整體資料的0.0009，決定於分析時排除。
因此僅需站點名稱即可。
<br>

```{r get taoyuan, eval=FALSE, echo=TRUE}
#獲取桃園站點的資料
station_data_taoyuan <- fromJSON("taoyuan_station_json.json")
station_data_taoyuan <- station_data_taoyuan %>% select(sna) %>% pull(sna)
```
</details>
### 3. 資料清理：修正或標記異常值
讀入示範資料 sample_data.rds，並將 duration 欄位由字串格式轉換為數值型的秒數（以利後續計算）。
```{r sample_data, eval=TRUE, echo=TRUE}
all_data <- readRDS("sample_data.rds")
#將duration由字串轉換為時間
all_data <- mutate(all_data, duration = period_to_seconds(hms(duration)))
```

確認資料是否有缺失或異常值，  
並採取以下兩種做法：  
1. 修改回正確值  
2. 標記並於分析時排除  
```{r is_excluded, eval=TRUE, echo=TRUE}
#新增欄位is_excluded,標記異常資料
all_data <- mutate(all_data, is_excluded = 0)
```
##### **確認缺失值並修正**
```{r is_empty, eval=TRUE, echo=TRUE}
#檢查各欄位是否有空字串或NULL
filter(all_data, is.na(start_time))
filter(all_data, is.na(end_time))
filter(all_data, is.na(start_station)|start_station=="") #7筆為NA(NULL)
filter(all_data, is.na(end_station)|end_station=="") #28筆為NA(NULL)
filter(all_data, is.na(duration)) 
filter(all_data, is.na(ride_date))
```
- 對於缺少「借車站點」與「還車站點」的資料，原檔共計 35 筆，占比極小。由於無法推斷原始站點，故將其標記為異常並排除於後續分析中。
```{r mark empty, eval=TRUE, echo=TRUE}
#標記start_station為NULL的資料
all_data <- mutate(all_data, is_excluded=ifelse(start_station==""|is.na(start_station), 1, is_excluded))

#標記end_station為NULL的資料
all_data <- mutate(all_data, is_excluded=ifelse(end_station==""|is.na(end_station), 1, is_excluded))
```
##### **確認異常值並修正**
- 檢查站點個數是否異常。
台北市共有為1622個站點，新北市為1461個，總數為3083。
因此：
- start_station合理站點數應不超過1622站。
- end_station可包含其他縣市的所有站點，應約3083站或以下。
```{r check station,eval=TRUE, echo=TRUE}
#檢查站點個數是否合理
length(unique(all_data$start_station)) #結果: 1527個 
length(unique(all_data$end_station)) #結果: 2855個
```
- 借用日期是否有異常值。
```{r check ride_date ,eval=TRUE, echo=TRUE}
#是否有非7月到12月的資料
filter(all_data, !month(ride_date) %in% 7:12)
```
- 借用時長是否異常。  
YouBike 的主要使用情境為短程通勤與移動，因此本分析設定合理借用時長為 1 分鐘至 6 小時（60 至 21,600 秒）。  
超出此範圍者視為異常值，將其標記並排除於後續分析中。  
此類資料佔整體比例約為 0.001%，比例極低，對分析影響有限。  
```{r mark outliers, eval=TRUE, echo=TRUE}
#將騎乘時間大於6小時之資料排除於分析
all_data <- all_data %>% mutate(is_excluded = if_else(duration>21600|duration<60, 1, is_excluded))
```
- 建立正確站點名單與資料比對  
  
租借資料中需要確認站點名稱的欄位有：  
1. start_staion (僅限台北市站點)  
2. end_station  (包含台北市、新北市及其他縣市站點)  
因此兩者分別處理。  
  
##### 修正 start_station 中的異常站名： 
建立包含台北市與新北市所有站點名稱的比對清單 correct_names，用於檢查站點名稱是否正確：   
```{r correct station_name, eval=TRUE, echo=TRUE}
#讀入station_data
station_data <- readRDS("station_data.rds")
#建立correct_names清單
correct_names <- station_data %>%
  distinct(station_name) %>%
  pull(station_name)

correct_names %>% 
  head(10) %>% 
  kable(caption = "correct_names清單(前十筆)")
```
接著找出 start_staion 欄位中未出現在 station_data 中的站點名稱。
```{r not_in_station_data, eval=TRUE, echo=TRUE}
#交叉比對, 把在all_data裡卻不在station_data裡的資料拉出來修正(start_station)
not_in_station_data <- anti_join(all_data, station_data, by = c("start_station" = "station_name"))
not_in_station_data_distinct <- not_in_station_data %>%
  filter(is_excluded==0) %>% 
  distinct(start_station) %>% pull(start_station)
not_in_station_data_distinct
```
人工修正異常站名
針對異常站名，使用stringdist()對比相似度找出最接近的站名，  
並由人工決定是否修正或排除：

若因站名有誤則進行修正：  
```{r check station_name, eval=TRUE, echo=TRUE}
#比對出類似名稱找出最接近站名，並修正
#修正not_in_station_data_distinct[1]
string_diffs <- stringdist(not_in_station_data_distinct[1], correct_names, method="lv")
similar_names <- data.frame(name=correct_names, string_diff=string_diffs) %>% 
  filter(string_diff <=3) %>% arrange(string_diff)
#需修改站名
not_in_station_data_distinct[1]
#人工確認similar_names，選擇最接近的站名
similar_names %>% head(10)
#修改後站名
correct_name <- "瑠公公園"
#修正站名
wrong_name <- not_in_station_data_distinct[1]
#修正前
#start_station欄位等於此次須修正站名的資料
target_rows_start <- which(all_data$start_station == wrong_name)
filter(all_data, start_station==wrong_name)
#若end_station裡也有同樣錯誤的站名，則一同修正
target_rows_end <- which(all_data$end_station == wrong_name)
filter(all_data, end_station==wrong_name)
#修正錯誤站名
all_data$start_station[target_rows_start] <- correct_name
all_data$end_station[target_rows_end] <- correct_name
#確認修正成功
filter(all_data, start_station==wrong_name)
filter(all_data, end_station==wrong_name)
```
若某些名稱（如「蘆洲維修中心」）確定不屬於使用站點，則標記排除。
```{r mark, eval=FALSE, echo=TRUE}
#修正not_in_station_data_distinct[28]
#蘆洲維修中心不算站點
not_in_station_data_distinct[28]
all_data <- mutate(all_data, is_excluded=if_else(!is.na(start_station) & start_station=="蘆洲維修中心", 1 ,is_excluded))
all_data <- mutate(all_data, is_excluded=if_else(!is.na(end_station) & end_station=="蘆洲維修中心", 1 ,is_excluded))
```

最後確認start_station名稱皆已完全修正。
```{r not_in_staion_data3, eval=TRUE, echo=TRUE}
not_in_station_data <- anti_join(all_data, station_data, by = c("start_station" = "station_name"))
not_in_station_data_distinct <- not_in_station_data %>%
  filter(is_excluded==0) %>% 
  distinct(start_station) %>% pull(start_station)
#確認not_in_station_data_distinct為空
not_in_station_data_distinct
```
##### 修正 end_station 中的異常站名：
end_station 資料中可能包含來自其他縣市的站點名稱，例如桃園。  
由於本分析聚焦於台北市與新北市，故將桃園站點資料標記排除。  
```{r mark station in taoyuan,eval=TRUE, echo=TRUE}
#匯入start_station欄位已清理的檔案
all_data <- readRDS("all_data_cleaned_startstation.rds")
station_data_taoyuan <- readRDS("station_data_taoyuan.rds")
station_data_taoyuan <- station_data_taoyuan %>% select(sna) %>% pull(sna)
#將含有桃園站點資料排除
all_data <- all_data %>% 
  mutate(is_excluded=if_else(end_station %in% station_data_taoyuan, 1, is_excluded))
```
同樣地，建立需修正清單。
```{r not_in_staion_data2, eval=TRUE, echo=TRUE}
##交叉比對, 把沒有在station_data裡的資料拉出來修正(end_station)
not_in_station_data <- anti_join(all_data, station_data, by = c("end_station" = "station_name"))
not_in_station_data_distinct <- not_in_station_data %>%
  filter(is_excluded==0) %>% 
  distinct(end_station) %>% pull(end_station)
not_in_station_data_distinct
```
需修正清單內大部分站點位於台北市及新北市之外，少部分為錯字，  
因此人工檢視異常站名後建立對應正確站名清單 corrections。  
內容如下：  
- before：錯誤站名。  
- after：對應修正後的站名，若為 "1" 表示將該資料排除。  
  
※ cat() 原為除錯時觀察用，目前已註解停用  
```{r correct end_staiton, eval=TRUE, echo=TRUE}
#對應正確站名清單
corrections <- data.frame(
  # before:錯誤名稱, after:正確的名稱，或 1 表示排除，空值表示跳過
  before = not_in_station_data_distinct,
  after = c("華江一華江五路口(雙江翠社區)", "啟文央北二路口(中央公園社區)", "環河西新月一街口(新月天地社區)",
            "環河西華江六路口(翠亨村社區)", "1", "中正路145巷口", "渡船頭平面停車場", "瓦磘溝(福真里)",
            "1", "瓦磘截流站", "十四張央北二路口(波爾多社區)", "華江二華江一路口(帝國花園廣場社區)",
            "新北市藝文中心(文化路二段124巷)", "1", "華江一華江二路口(江匯Life社區)", "金城峯廷街口", "十四張啓文路口", "新北市政府板橋分局沙崙派出所", "1", "捷運海山站(3號出口)轉乘停車場", "1",
            "浮洲合宜住宅(合安一合宜路口)", "華江五華江一路口(帝國花園廣場社區)", "汐止國民運動中心游泳池(忠孝東路)", "後埔國小(實踐路/重慶路155巷口)",
            "1", "1", "永翠藝文街口(柏克萊公園社區)", "中央慶利街口(風華綠中央社區)", "1", "1", "1",
            "1", "1", "新春街125巷(樂活绽社區)", "輕軌濱海義山站(西南側)", "1", "1", "1", "1")    
)        
#修正站名
for (i in seq_len(nrow(corrections))) {
  wrong <- corrections$before[i]
  fix <- corrections$after[i]
  
  target_rows <- which(all_data$end_station == wrong)
  
  if (length(target_rows) > 0) {
    if (fix == "1") {  # 要排除的情況
      all_data$is_excluded[target_rows] <- 1
      #cat("已排除", length(target_rows), "筆資料：", wrong, "\n")
    } else if (nchar(fix) > 0) {  # 要修正名稱
      all_data$end_station[target_rows] <- fix
      #cat("已修正", length(target_rows), "筆資料：", wrong, "→", fix, "\n")
    } else {  # fix 為空的情況
      #cat("跳過：", wrong, "\n")
    }
  } else {
    #cat("找不到資料：", wrong, "\n")
  }
}
```
確認end_station裡的站點名稱已修正。
```{r not_in_staion_data4, eval=TRUE, echo=TRUE}
not_in_station_data <- anti_join(all_data, station_data, by = c("end_station" = "station_name"))
not_in_station_data_distinct <- not_in_station_data %>%
  filter(is_excluded==0) %>% 
  distinct(end_station) %>% pull(end_station)
#確認not_in_station_data_distinct為空
not_in_station_data_distinct
```
部分站點（如福壽公園、後港公園等）在臺北與新北均有同名站點，且原始資料無法進一步辨識其所屬縣市，為避免地區分析誤判，故排除此類站點之資料（共 75,229 筆，占總資料約 0.79%）。
```{r samename, eval=TRUE, echo=TRUE}
#排除同名站點
excluded_station <- station_data %>% count(station_name) %>% filter(n > 1) %>% pull(station_name)
all_data <- all_data %>% 
  mutate(is_excluded = if_else(start_station %in% excluded_station | end_station %in% excluded_station, 1, is_excluded))
```
### 4. 資料分析
資料分析部分，將使用排除異常值後的資料（is_excluded = 0）進行分析。
```{r ,eval=TRUE, echo=TRUE}
#保留未被標記為異常的資料，作為分析依據
all_data <- all_data %>% 
  filter(is_excluded==0)
```
為了分析不同時段的使用行為，首先根據借車時間新增兩個欄位：  
- weekday_type：區分平日與假日（Weekday：星期一至五；Weekend：星期六與日）   
- time_period：依據不同日類（平日或假日）進一步細分時間段如下：  
  
平日 ( Weekday )  
- CommuteAM：早上通勤時間 ( 6:00-8:59 )    
- DayTime：白天 ( 9:00-15:59 )  
- CommutePM：晚上通勤時間 ( 16:00-18:59 )    
- NightTime：夜間 ( 19:00-5:59 )  
    
假日 ( Weekend )  
- Morning：早上 ( 6:00-12:59 )  
- Afternoo：下午 ( 13:00-18:59 )    
- Night：夜間 ( 19:00-5:59 )  

```{r weekdays_timeperiod, eval=TRUE, echo=TRUE}
#新增平假日欄位
all_data <- all_data %>% 
  mutate(
    weekday_type = case_when(
      is.na(start_time) ~ NA,
      wday(start_time, week_start =1) %in% 1:5 ~ "Weekday",
      wday(start_time, week_start =1) %in% 6:7 ~ "Weekend",
      TRUE ~ "error")
  )
#新增時間區段欄位
all_data <- all_data %>% 
  mutate(
    time_period = case_when(
      is.na(start_time) ~ NA, 
      weekday_type=="Weekday" ~ case_when(
        hour(start_time) %in% 6:8 ~ "CommuteAM",
        hour(start_time) %in% 9:15 ~ "DayTime", 
        hour(start_time) %in% 16:18 ~ "CommutePM",
        (hour(start_time) %in% 19:23)|(hour(start_time) %in% 0:5) ~ "NightTime",
        TRUE ~ "weekday_error"),
      weekday_type=="Weekend" ~
        case_when(hour(start_time) %in% 6:12 ~ "Morning",
                  hour(start_time) %in% 13:18 ~ "Afternoon",
                  (hour(start_time) %in% 19:23)|(hour(start_time) %in% 0:5) ~ "Night",
                  TRUE ~ "weekend_error"),
      TRUE ~ "error")
  )
```
根據租借紀錄，分別建立借出表及歸還表，
並合併為demand_gap資料表，以統整每個站點的借還情況。  
由於此分析僅分析台北市站點，因此僅保留台北市站點資料，  
並保留行政區、緯度、經度及容量等欄位。  
```{r borrow_return, eval=TRUE, echo=TRUE}
#建立借出表(borrow_df) & 排除非台北市資料 
all_data_with_str_area <- all_data %>% 
  left_join(station_data %>% select(station_name, district, capacity), 
            by = c("start_station" = "station_name"))
borrow_df  <- all_data_with_str_area %>% 
  filter(str_detect(district, "台北市"))  %>%
  group_by(start_station, weekday_type, time_period) %>%
  summarise(borrow_count = n(), .groups = "drop") %>%
  rename(station = start_station)

#建立歸還表(return_df) & 排除非台北市資料
all_data_with_end_area<- all_data %>% 
  left_join(station_data %>% select(station_name, district, capacity), 
            by = c("end_station" = "station_name"))
return_df <- all_data_with_end_area %>% 
  filter(str_detect(district, "台北市"))  %>%
  group_by(end_station, weekday_type, time_period) %>% 
  summarise(return_count=n(), .groups = "drop") %>% 
  rename(station = end_station)

#合併borrow_df和return_df & 加入站點區域、經緯度及容量資料
demand_gap <- full_join(borrow_df, return_df, by=c("station", "weekday_type", "time_period")) %>% 
  replace_na(list(borrow_count = 0, return_count = 0)) %>% 
  left_join(station_data %>% select(station_name, district, latitude, longitude, capacity), 
            by=c("station" = "station_name"))

#將站點區域中的"台北市"字樣移除
demand_gap <- demand_gap %>%
  mutate(district = str_remove(district, "^台北市"))
```
根據平日與假日的天數，計算各站點在不同時間段的「每日平均借出數」與「每日平均歸還數」，  
並新增欄位至 demand_gap 中。  

接著，計算兩者之差（借出 - 歸還），作為「每日平均借還差值」，新增至 avg_diff_per_day 欄位。
```{r couculate, eval=TRUE, echo=TRUE}
#新增平均每日借出及歸還欄位
#計算平日天數
n_weekdays <- all_data %>%
  filter(weekday_type == "Weekday") %>%
  summarise(n_weekdays = n_distinct(ride_date)) %>%
  pull(n_weekdays)
#計算假日天數
n_weekends <- all_data %>%
  filter(weekday_type == "Weekend") %>%
  summarise(n_weekends = n_distinct(ride_date)) %>%
  pull(n_weekends)
#計算每日平均借出及歸還數量
demand_gap <- demand_gap %>% 
  mutate(
    borrow_per_day = case_when(
      weekday_type=="Weekday" ~ round(borrow_count/n_weekdays, 2),
      weekday_type=="Weekend" ~ round(borrow_count/n_weekends, 2)
    ),
    return_per_day = case_when(
      weekday_type=="Weekday" ~ round(return_count/n_weekdays, 2),
      weekday_type=="Weekend" ~ round(return_count/n_weekends, 2)
    )
  )
#計算並新增每日平均借還差值
demand_gap <- demand_gap %>% 
  mutate(
    avg_diff_per_day = round(borrow_per_day-return_per_day, 2)
  )
```
由於站點數量眾多，若全數呈現將導致圖表過於雜亂，
且部分站點的每日借還差值變化小，實際上無需特別調度。

因此，本分析僅聚焦於「特定時間段內借還差值絕對值較大」的站點，
並依據不平衡程度進行排序，篩選出前 100 名站點作為分析對象，以利後續觀察與制定建議。
```{r top_100, eval=TRUE, echo=TRUE}
#重新排列順序
demand_gap <- demand_gap %>%
  select(station, weekday_type, time_period, avg_diff_per_day, capacity, borrow_count, return_count, borrow_per_day, return_per_day, district, latitude, longitude)

#找出「某一時間段內每日平均差值」最大的前 100 筆站點資料
top_100_station_name <- demand_gap %>% 
  group_by(station) %>% 
  summarise(total_diff_per_day = sum(abs(avg_diff_per_day), na.rm=TRUE)) %>% 
  arrange(desc(abs(total_diff_per_day))) %>% 
  slice_head(n=100) %>% 
  pull(station)

#僅針對前100個站點進行分析
top_100_station_data <- demand_gap %>% 
  filter(station %in% top_100_station_name)
```

為更直觀呈現各站點於不同時間段的供需差異，製作氣泡圖：

- 氣泡大小：代表站點每日平均借還差值的絕對值（需求不平衡程度）
- 圖形樣式：空心圓表示借出量大於歸還量（需補充車輛），實心圓表示歸還量大於借出量（需取走車輛）
- 顏色：代表不同行政區，以利觀察地區分布差異

從圖中可觀察到：
**平日的早上（CommuteAM）與傍晚（CommutePM）**供需情形多呈互補，早上車輛大量被借出、傍晚則陸續歸還；
**假日的早上（Morning）與夜間（Night）**亦呈現類似的互補現象。

這代表部分站點的車輛會隨時間自然流動回原站，不需特別安排大量調度作業，僅需掌握時間差即可達成平衡。
```{r graph, eval=TRUE, echo=TRUE}
#根據時間段畫出氣泡圖
#將time_period轉為因子並設定順序
top_100_station_data <- top_100_station_data %>%
  mutate(time_period = factor(time_period, levels = c(
    "CommuteAM", "DayTime", "CommutePM", "NightTime",  # 平日
    "Morning", "Afternoon", "Night"                    # 假日
  )))
invisible(
  ggplot(top_100_station_data, aes(x = longitude, y = latitude)) +
    geom_point(aes(
      size = abs(avg_diff_per_day),        # 氣泡大小：差值絕對值
      color = district,                    # 氣泡顏色：行政區
      shape = avg_diff_per_day > 0         # 形狀：借出>歸還(TRUE) / 借出<歸還(FALSE)
    ), alpha = 0.7) +
    facet_wrap(~ time_period, nrow = 2) +
    scale_size_continuous(range = c(1, 8)) +
    scale_color_viridis_d(option = "turbo", name = "行政區")+
    scale_shape_manual(
      values = c(`TRUE` = 1, `FALSE` = 16),    #  借出>歸還(TRUE)：空心圓，借出<歸還(FALSE)：實心圓
      breaks = c(FALSE, TRUE),
      labels = c(`TRUE` = "需補車", `FALSE` = "需取車"),
      name = "調度方向"
    ) +
    labs(
      title = "各時段YouBike站點供需不平衡地圖",
      size = "日均差值（絕對值）",
      x = "經度", y = "緯度"
    ) +
  theme_minimal()
)
ggsave("時間段氣泡圖.png", width = 14, height = 8, dpi = 300, bg="white")
```
<div style="border: 1px solid black; display: inline-block;">
  <img src="時間段氣泡圖.png" width="100%">
</div>
由於前述圖表中觀察到部分站點在不同時段間具有供需互補現象，表示其不平衡情形僅限於短時間段
因此，將站點依據「每日平均借還差值」分為兩類：  
  
short_term_imbalanced_stations（短時間不平衡站點）：
整日差值絕對值小於 10，代表整體供需還算平衡。
雖特定時段（如通勤時間）借還量差異大，但全天流動能夠自然補足。
僅需針對該時段進行少量調整，無需進行大規模調度。
  
daily_imbalanced_stations（整日不平衡站點）：
整日差值絕對值超過 10，代表整體供需長期不平衡。
制定較詳細的調度規劃，避免長時間出現無車可借或無位可還的情形。 
```{r 2set, eval=TRUE, echo=TRUE}
#將站點分為短時間不平衡及整體不平衡
total_diff_data <- demand_gap %>% 
  filter(station %in% top_100_station_name, ) %>% 
  group_by(station) %>% 
  summarise(total_diff_per_day = sum(avg_diff_per_day, na.rm=TRUE)) 

#短時間不平衡名單(整日差值小於10)
short_term_imbalanced_stations <- total_diff_data %>% 
  filter(abs(total_diff_per_day)<10) %>% 
  pull(station)
#整體不平衡名單(整日差值大於10)
daily_imbalanced_stations <- total_diff_data %>% 
  filter(!station %in% short_term_imbalanced_stations) %>% 
  pull(station)
```
#### 短時間不平衡站點之調度規劃  
本段程式碼針對平日早上通勤時段後的站點，整理出需進行輕度調度的名單。  
  
由於這些站點大多屬於通勤型站點，其特性為：  
- 早上大量借車、下午大量還車，或  
- 早上大量還車、下午大量借車。  

因此，調度建議不需完全平衡供需，而是以維持基本運作為目標：  
- 若「**借出多於還車**」：僅需**保留 1～3 輛可借車輛**。  
- 若「**還車多於借出**」：僅需**保留 1～3個可還空位**，避免爆滿。  

此分析報告內針對短時間不平衡的站點，提出四個輕度調度計畫，
分別是  
- 平日早上：預計9:00後開始調度。  
- 平日晚間：預計19:00後開始調度。  
- 假日午間：預計11:00後開始調度。  
- 假日晚間：預計18:00後開始調度。  
```{r short_time_weekday_morning, eval=TRUE, echo=TRUE}
#短時間不平衡：平日_早上通勤時間後調度名單。
availability_watchlist_weekday_morning <- demand_gap %>% 
  filter(station %in% short_term_imbalanced_stations, time_period %in% c("NightTime", "CommuteAM")) %>%
  group_by(station, district) %>% 
  summarise(total_diff=sum(avg_diff_per_day, na.rm=TRUE),
            .groups="drop") %>% 
  filter(abs(total_diff)>10) %>% 
  mutate(recommend_action = 
           case_when(
             total_diff>0 ~ "補充",
             total_diff<0 ~ "取車"
           )) %>% 
  select(station, district, recommend_action) %>% 
  arrange(district, recommend_action, station)

availability_watchlist_weekday_morning %>% 
  head(5) %>% 
  kable(caption = "輕度配對清單（平日早上）前五筆")
```
下面是另外三個其他時段清單。  
其程式碼邏輯與平日早上相同，僅調整 time_period 條件，故此處不再重複列出。
```{r short_time_the_other, eval=TRUE, echo=FALSE}
#短時間不平衡：平日_晚間通勤時間後調度名單。
availability_watchlist_weekday_evening <- demand_gap %>% 
  filter(station %in% short_term_imbalanced_stations, time_period %in% c("Daytime", "CommutePM")) %>%
  group_by(station, district) %>% 
  summarise(total_diff=sum(avg_diff_per_day, na.rm=TRUE),
            .groups="drop") %>% 
  filter(abs(total_diff)>10) %>% 
  mutate(recommend_action = 
           case_when(
             total_diff>0 ~ "補充",
             total_diff<0 ~ "取車"
           )) %>% 
  select(station, district, recommend_action) %>% 
  arrange(district, recommend_action, station)

availability_watchlist_weekday_evening %>% 
  head(5) %>% 
  kable(caption = "輕度配對清單（平日晚間）前五筆")
```

```{r short_time_the_other2, eval=TRUE, echo=FALSE}
#短時間不平衡：假日_午間調度名單
availability_watchlist_weekend_noon <- demand_gap %>% 
  filter(station %in% short_term_imbalanced_stations, time_period %in% c("Night", "Morning")) %>%
  group_by(station, district) %>% 
  summarise(total_diff=sum(avg_diff_per_day, na.rm=TRUE),
            .groups="drop") %>% 
  filter(abs(total_diff)>10) %>% 
  mutate(recommend_action = 
           case_when(
             total_diff>0 ~ "補充",
             total_diff<0 ~ "取車"
           )) %>% 
  select(station, district, recommend_action) %>% 
  arrange(district, recommend_action, station)

availability_watchlist_weekend_noon%>% 
  head(5) %>% 
  kable(caption = "輕度配對清單（假日午間）前五筆")
```

```{r short_time_the_other3, eval=TRUE, echo=FALSE}
#短時間不平衡：假日_夜間調度名單
availability_watchlist_weekend_night <- demand_gap %>% 
  filter(station %in% short_term_imbalanced_stations, time_period=="Afternoon", abs(avg_diff_per_day)>10) %>% 
  mutate(recommend_action = 
           case_when(
             avg_diff_per_day>0 ~ "補充",
             avg_diff_per_day<0 ~ "取車"
           )) %>% 
  select(station, district, recommend_action) %>% 
  arrange(district, recommend_action, station)

availability_watchlist_weekend_night%>% 
  head(5) %>% 
  kable(caption = "輕度配對清單（假日晚間）前五筆")
```
#### 整日不平衡站點之調度規劃
針對整日借還差值超過 10 輛的站點，計畫以「每日平均借還差值」為基準進行調度，  
並為避免無車可借或無空位可還的情況：
- **補充時留下至少3個空位**。
- **取車時留下至少1/3容量的車輛**。

針對整日不平衡站點，整理出各時段的建議調度數量。時間與輕度調度清單相同。分別是  
- 平日早上：預計9:00後開始調度。  
- 平日晚間：預計19:00後開始調度。  
- 假日午間：預計11:00後開始調度。  
- 假日晚間：預計18:00後開始調度。  
```{r dispatch_plan_weekday_morning, eval=TRUE, echo=TRUE}
#整日不平衡：平日_早上通勤時段後調度清單
dispatch_plan_weekday_morning <- demand_gap %>% 
  filter(station %in% daily_imbalanced_stations, time_period %in% c("NightTime", "CommuteAM")) %>%
  group_by(station, district) %>% 
  summarise(total_diff = sum(avg_diff_per_day, na.rm=TRUE), capacity=min(capacity), latitude=min(latitude), longitude=min(longitude), .groups="drop") %>% 
  mutate(
    dispatch_number=ceiling(total_diff),
    recommend_action=(
      case_when(
        total_diff >0 ~ "補充",
        total_diff <0 ~ "取車"
        )
    ),
    min_bike_required = ceiling(capacity*1/3)
  ) %>% 
  select(station, district, recommend_action, dispatch_number, min_bike_required, latitude, longitude) %>% 
  arrange(district, recommend_action, station)

dispatch_plan_weekday_morning %>% 
  head(5) %>% 
  kable(caption = "配對清單（平日早上）前五筆")
```
```{r the_other_dispatch_plan, eval=TRUE, echo=FALSE}
#整日不平衡：平日_晚間通勤時段後調度名單
dispatch_plan_weekday_evening <- demand_gap %>% 
  filter(station %in% daily_imbalanced_stations, time_period %in% c("Daytime", "CommutePM")) %>%
  group_by(station, district) %>% 
  summarise(total_diff = sum(avg_diff_per_day, na.rm=TRUE), capacity=min(capacity), latitude=min(latitude), longitude=min(longitude), .groups="drop") %>% 
  mutate(
    dispatch_number=ceiling(total_diff),
    recommend_action=(
      case_when(
        total_diff >0 ~ "補充",
        total_diff <0 ~ "取車"
      )
    ),
    min_bike_required = ceiling(capacity*1/3)
  ) %>% 
  select(station, district, recommend_action, dispatch_number, min_bike_required, latitude, longitude) %>% 
  arrange(district, recommend_action, station)

#整日不平衡：假日_午間調度名單
dispatch_plan_weekend_noon <- demand_gap %>% 
  filter(station %in% daily_imbalanced_stations, time_period %in% c("Night", "Morning")) %>%
  group_by(station, district) %>% 
  summarise(total_diff = sum(avg_diff_per_day, na.rm=TRUE), capacity=min(capacity), latitude=min(latitude), longitude=min(longitude), .groups="drop") %>% 
  mutate(
    dispatch_number=ceiling(total_diff),
    recommend_action=(
      case_when(
        total_diff >0 ~ "補充",
        total_diff <0 ~ "取車"
      )
    ),
    min_bike_required = ceiling(capacity*1/3)
  ) %>% 
  select(station, district, recommend_action, dispatch_number, min_bike_required, latitude, longitude) %>% 
  arrange(district, recommend_action, station)

#整日不平衡：假日_晚間調度名單
dispatch_plan_weekend_night <- demand_gap %>% 
  filter(station %in% daily_imbalanced_stations, time_period =="Afternoon") %>%
  mutate(
    dispatch_number=ceiling(avg_diff_per_day),
    recommend_action=(
      case_when(
        avg_diff_per_day >0 ~ "補充",
        avg_diff_per_day <0 ~ "取車"
      )
    ),
    min_bike_required = ceiling(capacity*1/3)
  ) %>% 
  select(station, district, recommend_action, dispatch_number, min_bike_required, latitude, longitude) %>% 
  arrange(district, recommend_action, station)
```
5. 調度策略初步建議

針對短時間不平衡站點，以維持基本運作為目標：  
- 若「**借出多於還車**」：僅需**保留 1～3 輛可借車輛**。  
- 若「**還車多於借出**」：僅需**保留 1～3個可還空位**，避免爆滿。

針對整日不平衡站點，做更詳細的規劃，以「每日平均借還差值」為基準進行調度。   
並注意以下兩點即可：
- **補充時留下至少3個空位**。
- **取車時留下至少1/3容量的車輛**。

根據上一步的整日不平衡調度配對清單，  
接下來可以站點間的距離為基礎，進一步配對需取車及需補車的站點。  
調度人員可依據此配對清單，規劃適當的調度路線。  

同樣根據四個時間段分別建立調度配對清單。  
包含：    
- 平日早上：dispatch_plan_weekday_morning_match_list   
- 平日晚間：dispatch_plan_weekday_evening_match_list
- 假日午間：dispatch_plan_weekend_noon_match_list
- 假日晚間：dispatch_plan_weekend_night_match_list
```{r weekday_morning_match_list, eval=TRUE, echo=TRUE}
#針對整天不平衡
#整天不平衡:平日_早上調度配對
#需補車站點
stations_need_bike <- dispatch_plan_weekday_morning %>% 
  filter(dispatch_number > 0) %>% 
  select(station, longitude, latitude, dispatch_number, district) %>% 
  rename(need=dispatch_number)
#需取車站點
stations_with_extra <- dispatch_plan_weekday_morning %>% 
  filter(dispatch_number < 0) %>% 
  select(station, longitude, latitude, dispatch_number, district, min_bike_required) %>% 
  rename(extra=dispatch_number)


# 設定最大配對距離（單位：公尺）
max_distance <- 2000

# 初始化
routes_one_to_one <- data.frame()
used_extras <- c()

# 依序處理每個補車站
for (i in 1:nrow(stations_need_bike)) {
  need_row <- stations_need_bike[i, ]
  
  # 找出尚未被配對的取車站
  available_extras <- stations_with_extra %>% 
    filter(!station %in% used_extras)
  
  if (nrow(available_extras) == 0) break  # 如果沒有取車站可配對，結束
  
  # 計算該補車站與所有尚未配對取車站的距離
  distances <- distHaversine(
    matrix(c(need_row$longitude, need_row$latitude), ncol = 2),
    matrix(c(available_extras$longitude, available_extras$latitude), ncol = 2)
  )
  # 加入距離欄位，並篩選距離小於指定值的站點
  available_extras <- available_extras %>%
    mutate(distance = distances) %>%
    filter(distance <= max_distance)
  
  if (nrow(available_extras) == 0) next  # 若都太遠則跳過
  
  # 選擇距離最近的一個取車站
  closest_extra <- available_extras %>% slice_min(order_by = distance, n = 1)
  used_extras <- c(used_extras, closest_extra$station)  # 記錄已被配對的取車站
  
  # 建立配對紀錄
  routes_one_to_one <- bind_rows(
    routes_one_to_one,
    data.frame(
      station_need = need_row$station,
      longitude_need = need_row$longitude,
      latitude_need = need_row$latitude,
      need = need_row$need,
      station_extra = closest_extra$station,
      longitude_extra = closest_extra$longitude,
      latitude_extra = closest_extra$latitude,
      extra = closest_extra$extra,
      district_extra = closest_extra$district,
      distance = closest_extra$distance,
      min_bike_of_providing_staitoin = closest_extra$min_bike_required
    )
  )
}

# 整理結果表
dispatch_plan_weekday_morning_match_list <- routes_one_to_one %>% 
  select(station_need, need, longitude_need, latitude_need, station_extra, extra, longitude_extra, latitude_extra, district_extra, distance, min_bike_of_providing_staitoin) %>% 
  arrange(district_extra, extra)

dispatch_plan_weekday_morning_match_list %>% 
  head(5) %>% 
  kable(caption = "調度配對清單（平日早上）前五筆")
```

```{r the_other_match_list, eval=TRUE, echo=FALSE}

#整天不平衡:平日_晚間調度配對
stations_need_bike <- dispatch_plan_weekday_evening %>% 
  filter(dispatch_number > 0) %>% 
  select(station, longitude, latitude, dispatch_number, district) %>% 
  rename(need=dispatch_number)
stations_with_extra <- dispatch_plan_weekday_evening %>% 
  filter(dispatch_number < 0) %>% 
  select(station, longitude, latitude, dispatch_number, district, min_bike_required) %>% 
  rename(extra=dispatch_number)

routes_one_to_one <- data.frame()
used_extras <- c()

for (i in 1:nrow(stations_need_bike)) {
  need_row <- stations_need_bike[i, ]

  available_extras <- stations_with_extra %>% 
    filter(!station %in% used_extras)
  
  if (nrow(available_extras) == 0) break 
  
  distances <- distHaversine(
    matrix(c(need_row$longitude, need_row$latitude), ncol = 2),
    matrix(c(available_extras$longitude, available_extras$latitude), ncol = 2)
  )
  
  available_extras <- available_extras %>%
    mutate(distance = distances) %>%
    filter(distance <= max_distance)
  
  if (nrow(available_extras) == 0) next
  
  closest_extra <- available_extras %>% slice_min(order_by = distance, n = 1)
  used_extras <- c(used_extras, closest_extra$station)  # 記錄已被配對的取車站
  
  routes_one_to_one <- bind_rows(
    routes_one_to_one,
    data.frame(
      station_need = need_row$station,
      longitude_need = need_row$longitude,
      latitude_need = need_row$latitude,
      need = need_row$need,
      station_extra = closest_extra$station,
      longitude_extra = closest_extra$longitude,
      latitude_extra = closest_extra$latitude,
      extra = closest_extra$extra,
      district_extra = closest_extra$district,
      distance = closest_extra$distance,
      min_bike_of_providing_staitoin = closest_extra$min_bike_required
    )
  )
}

# 整理結果表
dispatch_plan_weekday_evening_match_list <- routes_one_to_one %>% 
  select(station_need, need, longitude_need, latitude_need, station_extra, extra, longitude_extra, latitude_extra, district_extra, distance, min_bike_of_providing_staitoin) %>% 
  arrange(district_extra, extra)

#整天不平衡:假日_午間調度配對

stations_need_bike <- dispatch_plan_weekend_noon %>% 
  filter(dispatch_number > 0) %>% 
  select(station, longitude, latitude, dispatch_number, district) %>% 
  rename(need=dispatch_number)
stations_with_extra <- dispatch_plan_weekend_noon %>% 
  filter(dispatch_number < 0) %>% 
  select(station, longitude, latitude, dispatch_number, district, min_bike_required) %>% 
  rename(extra=dispatch_number)

routes_one_to_one <- data.frame()
used_extras <- c()

for (i in 1:nrow(stations_need_bike)) {
  need_row <- stations_need_bike[i, ]
  
  available_extras <- stations_with_extra %>% 
    filter(!station %in% used_extras)

  if (nrow(available_extras) == 0) break  # 如果沒有取車站可配對，結束

  distances <- distHaversine(
    matrix(c(need_row$longitude, need_row$latitude), ncol = 2),
    matrix(c(available_extras$longitude, available_extras$latitude), ncol = 2)
  )
  
  available_extras <- available_extras %>%
    mutate(distance = distances) %>%
    filter(distance <= max_distance)
  
  if (nrow(available_extras) == 0) next 
  
  closest_extra <- available_extras %>% slice_min(order_by = distance, n = 1)
  used_extras <- c(used_extras, closest_extra$station)  # 記錄已被配對的取車站
  
  routes_one_to_one <- bind_rows(
    routes_one_to_one,
    data.frame(
      station_need = need_row$station,
      longitude_need = need_row$longitude,
      latitude_need = need_row$latitude,
      need = need_row$need,
      station_extra = closest_extra$station,
      longitude_extra = closest_extra$longitude,
      latitude_extra = closest_extra$latitude,
      extra = closest_extra$extra,
      district_extra = closest_extra$district,
      distance = closest_extra$distance,
      min_bike_of_providing_staitoin = closest_extra$min_bike_required
    )
  )
}

# 整理結果表
dispatch_plan_weekend_noon_match_list <- routes_one_to_one %>% 
  select(station_need, need, longitude_need, latitude_need, station_extra, extra, longitude_extra, latitude_extra, district_extra, distance, min_bike_of_providing_staitoin) %>% 
  arrange(district_extra, extra)

#整天不平衡:假日_晚間調度配對
stations_need_bike <- dispatch_plan_weekend_night %>% 
  filter(dispatch_number > 0) %>% 
  select(station, longitude, latitude, dispatch_number, district) %>% 
  rename(need=dispatch_number)
stations_with_extra <- dispatch_plan_weekend_night %>% 
  filter(dispatch_number < 0) %>% 
  select(station, longitude, latitude, dispatch_number, district, min_bike_required) %>% 
  rename(extra=dispatch_number)

routes_one_to_one <- data.frame()
used_extras <- c()

for (i in 1:nrow(stations_need_bike)) {
  need_row <- stations_need_bike[i, ]
  
  available_extras <- stations_with_extra %>% 
    filter(!station %in% used_extras)
  
  if (nrow(available_extras) == 0) break

  distances <- distHaversine(
    matrix(c(need_row$longitude, need_row$latitude), ncol = 2),
    matrix(c(available_extras$longitude, available_extras$latitude), ncol = 2)
  )
  available_extras <- available_extras %>%
    mutate(distance = distances) %>%
    filter(distance <= max_distance)
  
  if (nrow(available_extras) == 0) next 
  
  closest_extra <- available_extras %>% slice_min(order_by = distance, n = 1)
  used_extras <- c(used_extras, closest_extra$station)
  
  routes_one_to_one <- bind_rows(
    routes_one_to_one,
    data.frame(
      station_need = need_row$station,
      longitude_need = need_row$longitude,
      latitude_need = need_row$latitude,
      need = need_row$need,
      station_extra = closest_extra$station,
      longitude_extra = closest_extra$longitude,
      latitude_extra = closest_extra$latitude,
      extra = closest_extra$extra,
      district_extra = closest_extra$district,
      distance = closest_extra$distance,
      min_bike_of_providing_staitoin = closest_extra$min_bike_required
    )
  )
}

# 整理結果表
dispatch_plan_weekend_night_match_list <- routes_one_to_one %>% 
  select(station_need, need, longitude_need, latitude_need, station_extra, extra, longitude_extra, latitude_extra, district_extra, distance, min_bike_of_providing_staitoin) %>% 
  arrange(district_extra, extra)
```
並根據配對清單，製作出簡易配對圖表，顯示每對調度站點的位置與角色（補車或取車）。  

每一組調度配對會以相同顏色標示，  
圖中圓點代表站點，其中  
- 空心圓表示「需補車」。
- 實心圓表示「需取車」（代表站點有多餘車輛）。

下圖為平日早上時段的調度配對視覺化成果。
```{r weekday_morning_graph, eval=TRUE, echo=TRUE}

#製作調度配對圖
#建立一組不相似顏色列表
color_list<- c(
  "red", "blue", "green", "orange", "purple", "brown", "pink", "cyan",
  "black", "darkgreen", "darkblue", "goldenrod", "magenta", "gray20",
  "violet", "turquoise", "salmon", "darkred", "navy", "coral", "deeppink",
  "darkorange", "tomato", "maroon", "steelblue", "seagreen", "hotpink",
  "sienna", "dodgerblue", "firebrick", "slateblue", "mediumvioletred",
  "darkmagenta", "darkslateblue", "indigo", "crimson", "mediumblue",
  "darkcyan", "purple", "darkolivegreen"
)

#整天不平衡:平日早上配對圖
#建立配對編號
dispatch_plan_weekday_morning_match_list <- dispatch_plan_weekday_morning_match_list %>% 
  mutate(pair_id = row_number())

special_treatment_station <- dispatch_plan_weekday_morning_match_list %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_need" = "station_name")) %>% 
  rename("station_need_district" = "district") %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_extra" = "station_name")) %>% 
  rename("station_extra_district" = "district") %>% 
  filter(station_need_district %in% c( "台北市中正區", "台北市臺大公館校區") | station_extra_district %in% c( "台北市中正區","台北市臺大公館校區")) %>% 
  pull(pair_id)

#取出補車與取車資料為一張圖
dispatch_plan_weekday_morning_for_graph <- bind_rows(
  dispatch_plan_weekday_morning_match_list %>% 
    transmute(
      station = station_need,
      longitude = longitude_need, 
      latitude = latitude_need,
      role = "need_bike",
      pair_id = pair_id
    ),
  dispatch_plan_weekday_morning_match_list %>% 
    transmute(
      station = station_extra,
      longitude = longitude_extra,
      latitude = latitude_extra, 
      role = "extra_bike",
      pair_id = pair_id
    )
)

pair_ids <- unique(dispatch_plan_weekday_morning_for_graph$pair_id)

this_time_color <- setNames(color_list[1:length(pair_ids)], pair_ids)

invisible(
  ggplot(dispatch_plan_weekday_morning_for_graph) +
    geom_point(aes(x = longitude, y = latitude, color = factor(pair_id), shape = role), size = 2.5) +
    geom_text_repel(aes(x = longitude, y = latitude, label = station, color = factor(pair_id)), size = 2.5, max.overlaps = 100) +
    scale_color_manual(values = this_time_color, guide = "none") +
    scale_shape_manual(values = c("need_bike" = 1, "extra_bike" = 16))+
    theme(legend.position="none")+
    labs(title = "YouBike 平日早上調度配對圖", x = "經度", y = "緯度", color = "配對 ID") +
    theme_minimal()
)

ggsave("調度配對圖_平日早上.png", width = 14, height = 8, dpi = 300, bg="white")

```
<div style="border: 1px solid black; display: inline-block;">
  <img src="調度配對圖_平日早上.png" width="100%">
</div>
下面是其餘三個時間段的配對圖。
```{r the_other_graph, eval=TRUE, echo=FALSE}
#整天不平衡:平日晚間配對圖
#建立配對編號
dispatch_plan_weekday_evening_match_list <- dispatch_plan_weekday_evening_match_list %>% 
  mutate(pair_id = row_number())

special_treatment_station <- dispatch_plan_weekday_evening_match_list %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_need" = "station_name")) %>% 
  rename("station_need_district" = "district") %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_extra" = "station_name")) %>% 
  rename("station_extra_district" = "district") %>% 
  filter(station_need_district %in% c( "台北市中正區", "台北市臺大公館校區") | station_extra_district %in% c( "台北市中正區","台北市臺大公館校區")) %>% 
  pull(pair_id)

#取出補車與取車資料為一張圖
dispatch_plan_weekday_evening_for_graph <- bind_rows(
  dispatch_plan_weekday_evening_match_list %>% 
    transmute(
      station = station_need,
      longitude = longitude_need, 
      latitude = latitude_need,
      role = "need_bike",
      pair_id = pair_id
    ),
  dispatch_plan_weekday_evening_match_list %>% 
    transmute(
      station = station_extra,
      longitude = longitude_extra,
      latitude = latitude_extra, 
      role = "extra_bike",
      pair_id = pair_id
    )
)

pair_ids <- unique(dispatch_plan_weekday_evening_for_graph$pair_id)

this_time_color <- setNames(color_list[1:length(pair_ids)], pair_ids)

invisible(
  ggplot(dispatch_plan_weekday_evening_for_graph) +
    geom_point(aes(x = longitude, y = latitude, color = factor(pair_id), shape = role), size = 2.5) +
    geom_text_repel(aes(x = longitude, y = latitude, label = station, color = factor(pair_id)), size = 3, max.overlaps = 100) +
    scale_color_manual(values = this_time_color, guide = "none") +
    scale_shape_manual(values = c("need_bike" = 1, "extra_bike" = 16))+
    labs(title = "YouBike 平日晚間調度配對圖",
         x = "經度", y = "緯度", color = "配對 ID") +
    theme_minimal()
)
ggsave("調度配對圖_平日晚間.png", width = 14, height = 8, dpi = 300, bg="white")
# include_graphics("調度配對圖_平日晚間.png")

#整天不平衡:假日午間配對圖
#建立配對編號
dispatch_plan_weekend_noon_match_list <- dispatch_plan_weekend_noon_match_list %>% 
  mutate(pair_id = row_number())

special_treatment_station <- dispatch_plan_weekend_noon_match_list %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_need" = "station_name")) %>% 
  rename("station_need_district" = "district") %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_extra" = "station_name")) %>% 
  rename("station_extra_district" = "district") %>% 
  filter(station_need_district %in% c( "台北市中正區", "台北市臺大公館校區") | station_extra_district %in% c( "台北市中正區","台北市臺大公館校區")) %>% 
  pull(pair_id)

#取出補車與取車資料為一張圖
dispatch_plan_weekend_noon_for_graph <- bind_rows(
  dispatch_plan_weekend_noon_match_list %>% 
    transmute(
      station = station_need,
      longitude = longitude_need, 
      latitude = latitude_need,
      role = "need_bike",
      pair_id = pair_id
    ),
  dispatch_plan_weekend_noon_match_list %>% 
    transmute(
      station = station_extra,
      longitude = longitude_extra,
      latitude = latitude_extra, 
      role = "extra_bike",
      pair_id = pair_id
    )
)

pair_ids <- unique(dispatch_plan_weekend_noon_for_graph$pair_id)

this_time_color <- setNames(color_list[1:length(pair_ids)], pair_ids)
invisible(
  ggplot(dispatch_plan_weekend_noon_for_graph) +
    geom_point(aes(x = longitude, y = latitude, color = factor(pair_id), shape = role), size = 2.5) +
    geom_text_repel(aes(x = longitude, y = latitude, label = station, color = factor(pair_id)), size = 3, max.overlaps = 100) +
    scale_color_manual(values = this_time_color, guide = "none") +
    scale_shape_manual(values = c("need_bike" = 1, "extra_bike" = 16))+
    labs(title = "YouBike 假日午間調度配對圖",
         x = "經度", y = "緯度", color = "配對 ID") +
    theme_minimal()
)

ggsave("調度配對圖_假日午間.png", width = 14, height = 8, dpi = 300, bg="white")
# include_graphics("調度配對圖_假日午間.png")

#整天不平衡:假日晚間配對圖
#建立配對編號
dispatch_plan_weekend_night_match_list <- dispatch_plan_weekend_night_match_list %>% 
  mutate(pair_id = row_number())

special_treatment_station <- dispatch_plan_weekend_night_match_list %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_need" = "station_name")) %>% 
  rename("station_need_district" = "district") %>% 
  left_join(station_data %>% select(station_name, district), by= c("station_extra" = "station_name")) %>% 
  rename("station_extra_district" = "district") %>% 
  filter(station_need_district %in% c( "台北市中正區", "台北市臺大公館校區") | station_extra_district %in% c( "台北市中正區","台北市臺大公館校區")) %>% 
  pull(pair_id)

#取出補車與取車資料為一張圖
dispatch_plan_weekend_night_for_graph <- bind_rows(
  dispatch_plan_weekend_night_match_list %>% 
    transmute(
      station = station_need,
      longitude = longitude_need, 
      latitude = latitude_need,
      role = "need_bike",
      pair_id = pair_id
    ),
  dispatch_plan_weekend_night_match_list %>% 
    transmute(
      station = station_extra,
      longitude = longitude_extra,
      latitude = latitude_extra, 
      role = "extra_bike",
      pair_id = pair_id
    )
)

pair_ids <- unique(dispatch_plan_weekend_night_for_graph$pair_id)

this_time_color <- setNames(color_list[1:length(pair_ids)], pair_ids)

invisible(
  ggplot(dispatch_plan_weekend_night_for_graph) +
    geom_point(aes(x = longitude, y = latitude, color = factor(pair_id), shape = role), size = 2.5) +
    geom_text_repel(aes(x = longitude, y = latitude, label = station, color = factor(pair_id)), size = 3, max.overlaps = 100) +
    scale_color_manual(values = this_time_color, guide = "none") +
    scale_shape_manual(values = c("need_bike" = 1, "extra_bike" = 16))+
    labs(title = "YouBike 假日晚間調度配對圖",
         x = "經度", y = "緯度", color = "配對 ID") +
    theme_minimal()
)

ggsave("調度配對圖_假日晚間.png", width = 14, height = 8, dpi = 300, bg="white")
# include_graphics("調度配對圖_假日晚間.png")

```
<div style="border: 1px solid black; display: inline-block;">
  <img src="調度配對圖_平日晚間.png" width="100%">
</div>
<br>
<div style="border: 1px solid black; display: inline-block;">
  <img src="調度配對圖_假日午間.png" width="100%">
</div>
<br>
<div style="border: 1px solid black; display: inline-block;">
  <img src="調度配對圖_平日晚間.png" width="100%">
</div>

最後，將分析結果輸出為 CSV 檔案：

輕度調度清單：對於屬於「短時間不平衡」的站點，依據不同時間段（平日早上、晚上，假日午間與夜間）列出需要輕度調整的站點名單。

調度配對清單：針對「整日不平衡」站點，依據供需配對結果建立調度建議，包括需補車與可提供車輛的站點配對與數量建議。
```{r ouput_csv, eval=TRUE, echo=TRUE}
#將結果匯出
write_csv(availability_watchlist_weekday_morning, "輕度調度清單_平日早上.csv")
write_csv(availability_watchlist_weekday_evening, "輕度調度清單_平日晚間.csv")
write_csv(availability_watchlist_weekend_noon, "輕度調度清單_假日午間.csv")
write_csv(availability_watchlist_weekend_night, "輕度調度清單_假日晚間.csv")

dispatch_plan_weekday_morning_match_list <- dispatch_plan_weekday_morning_match_list %>% 
  select(station_need, need, station_extra, extra, min_bike_of_providing_staitoin) %>% 
  mutate(extra=abs(extra)) %>% 
  rename(station_requesting_bike = station_need, demand_number = need, station_providing_bike = station_extra, extra_number = extra )

write_csv(dispatch_plan_weekday_morning_match_list, "調度配對清單_平日早上.csv")

dispatch_plan_weekday_evening_match_list <- dispatch_plan_weekday_evening_match_list %>% 
  select(station_need, need, station_extra, extra, min_bike_of_providing_staitoin) %>% 
  mutate(extra=abs(extra)) %>% 
  rename(station_requesting_bike = station_need, demand_number = need, station_providing_bike = station_extra, extra_number = extra )
write_csv(dispatch_plan_weekday_evening_match_list, "調度配對清單_平日晚間.csv")

dispatch_plan_weekend_noon_match_list <- dispatch_plan_weekend_noon_match_list %>% 
  select(station_need, need, station_extra, extra, min_bike_of_providing_staitoin) %>% 
  mutate(extra=abs(extra)) %>% 
  rename(station_requesting_bike = station_need, demand_number = need, station_providing_bike = station_extra, extra_number = extra )
write_csv(dispatch_plan_weekend_noon_match_list, "調度配對清單_假日午間.csv")

dispatch_plan_weekend_night_match_list <- dispatch_plan_weekend_night_match_list %>% 
  select(station_need, need, station_extra, extra, min_bike_of_providing_staitoin) %>% 
  mutate(extra=abs(extra)) %>% 
  rename(station_requesting_bike = station_need, demand_number = need, station_providing_bike = station_extra, extra_number= extra )
write_csv(dispatch_plan_weekend_night_match_list, "調度配對清單_假日晚間.csv")

read_csv("輕度調度清單_平日早上.csv") %>%
  head(5) %>%
  kable(caption = "輕度調度清單（平日早上）前五筆")

read_csv("調度配對清單_平日早上.csv") %>%
  head(5) %>%
  kable(caption = "調度配對清單（平日早上）前五筆")
```
6. 結論與後續發展

本次分析成果摘要

未來可納入的資料或進階分析方向

對YouBike營運優化的建議

7. 附錄（程式碼與資料摘要）
重要程式碼片段（可選）

資料摘要表與圖表

要讓某些程式碼秀出結果?
主要表格
欄位要標記嗎``